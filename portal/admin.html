<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin User Management</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container py-5">
    <h2 class="mb-4">User List & Admin Controls</h2>
    <div class="mb-3">
      <label for="apiKeyInput" class="form-label">Admin API Key</label>
      <input type="password" class="form-control" id="apiKeyInput" placeholder="Enter your admin API key" required>
      <button id="loadUsersBtn" class="btn btn-primary mt-2">Load Users</button>
    </div>
    <div id="resultMessage" class="alert d-none"></div>
    <table class="table table-bordered" id="usersTable" style="display:none;">
      <thead>
        <tr>
          <th>Email</th>
          <th>UID</th>
          <th>Admin</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <script type="module">
    const apiKeyInput = document.getElementById('apiKeyInput');
    const loadUsersBtn = document.getElementById('loadUsersBtn');
    const resultMessage = document.getElementById('resultMessage');
    const usersTable = document.getElementById('usersTable');
    const tbody = usersTable.querySelector('tbody');

    async function fetchUsers(apiKey) {
      const res = await fetch('/api/listUsers', {
        headers: { 'x-api-key': apiKey }
      });
      return res.json();
    }

    async function setAdmin(uid, isAdmin, apiKey) {
      const res = await fetch('/api/setAdminClaim', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'x-api-key': apiKey },
        body: JSON.stringify(isAdmin ? { uid } : { uid, admin: false })
      });
      return res.json();
    }

    loadUsersBtn.addEventListener('click', async () => {
      const apiKey = apiKeyInput.value.trim();
      if (!apiKey) return;
      resultMessage.classList.add('d-none');
      usersTable.style.display = 'none';
      tbody.innerHTML = '<tr><td colspan="4">Loading...</td></tr>';

      const res = await fetchUsers(apiKey);
      if (res.users) {
        tbody.innerHTML = '';
        res.users.forEach(u => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${u.email || '(No Email)'}</td>
            <td>${u.uid}</td>
            <td>${u.admin ? '<span class="text-success">Yes</span>' : '<span class="text-danger">No</span>'}</td>
            <td>
              <button class="btn btn-sm btn-success setAdminBtn" ${u.admin ? 'disabled' : ''}>Make Admin</button>
              <button class="btn btn-sm btn-danger removeAdminBtn" ${u.admin ? '' : 'disabled'}>Remove Admin</button>
            </td>
          `;
          // Action handlers
          tr.querySelector('.setAdminBtn').addEventListener('click', async () => {
            const resp = await setAdmin(u.uid, true, apiKey);
            showResult(resp, 'Admin claim set for ' + (u.email || u.uid));
            loadUsersBtn.click(); // reload
          });
          tr.querySelector('.removeAdminBtn').addEventListener('click', async () => {
            const resp = await setAdmin(u.uid, false, apiKey);
            showResult(resp, 'Admin claim removed for ' + (u.email || u.uid));
            loadUsersBtn.click(); // reload
          });
          tbody.appendChild(tr);
        });
        usersTable.style.display = '';
      } else {
        showResult(res, 'Failed to load users');
      }
    });

    function showResult(res, fallbackMsg) {
      resultMessage.className = 'alert alert-' + (res.error ? 'danger' : 'success');
      resultMessage.textContent = res.message || res.error || fallbackMsg;
      resultMessage.classList.remove('d-none');
    }
  </script>
</body>
</html>